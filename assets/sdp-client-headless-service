#!/usr/bin/env sh

set +x

if [ -n "$CLIENT_DEVICE_ID" ]; then
    echo "Using custom device-id: $CLIENT_DEVICE_ID"
    echo "$CLIENT_DEVICE_ID" | sed 's|-||g' > /etc/machine-id
fi

cat > /sdp-service/appgate.conf <<EOF
[Settings]
LogLevel = $APPGATE_LOGLEVEL
[Credentials]
ControllerUrl = $APPGATE_PROFILE_URL
Username = $APPGATE_USERNAME
Password = $APPGATE_PASSWORD
EOF

echo Running service
CMD="/opt/appgate/service/appgateservice --config /sdp-service/appgate.conf --tun /var/run/sdp-driver/.driver.sock --service"

# If 6.0+ client, add -l flag
if [ "$CLIENT_VERSION" -ge 6 ]; then
    CMD="$CMD -l /var/log/appgate/driver.log"
fi

eval "${CMD}"
